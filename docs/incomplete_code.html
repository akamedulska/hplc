<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.1.163">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>RP-HPLC - Incomplete stan code</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./Model_2_utility_pH.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">Incomplete stan code</h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">RP-HPLC</a> 
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">Columns: XBridge Shield and XTerra</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro.html" class="sidebar-item-text sidebar-link">General model</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./Model_1.html" class="sidebar-item-text sidebar-link">Model 1</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Model_1_a.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Stan code</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Model_1_b.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Estimated parameters</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Model_1_c.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Comparison of population parameter values</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Model_1_d.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Comparison of individual parameter values</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./Model_2.html" class="sidebar-item-text sidebar-link">Model 2</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Model_2_a.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Stan code</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Model_2_b.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Estimated parameters</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Model_2_c.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Comparison of population parameter values</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Model2_logk.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">logk vs fi</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Model_2_pH.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">logk vs pH</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Model_2_utility_pH.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Utility function</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./incomplete_code.html" class="sidebar-item-text sidebar-link active">Incomplete stan code</a>
  </div>
</li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block">Incomplete stan code</h1>
</div>



<div class="quarto-title-meta">

    
    
  </div>
  

</header>

<p>Stan code for model:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>functions {

// credit http://srmart.in/informative-priors-for-correlation-matrices-an-easy-approach/
vector lower_tri(matrix mat) {

int d = rows(mat);
int lower_tri_d = d * (d - 1) / 2;
vector[lower_tri_d] lower;
int count = 1;
for(r in 2:d) {
for(c in 1:(r - 1)) {
lower[count] = mat[r,c];
count += 1;
}
}
return(lower); 
}

// credit http://srmart.in/informative-priors-for-correlation-matrices-an-easy-approach/
real lkj_corr_point_lower_tri_lpdf(matrix rho, vector point_mu_lower, vector point_scale_lower) {

real lpdf = lkj_corr_lpdf(rho | 1) + normal_lpdf(lower_tri(rho) | point_mu_lower, point_scale_lower);
return(lpdf);
}


real lkj_corr_cholesky_point_lower_tri_two_lpdf(matrix cor_L, real point_mu_lower, real point_scale_lower) {
    real lpdf = lkj_corr_cholesky_lpdf(cor_L | 1);
    int d = rows(cor_L);
    matrix[d,d] cor = multiply_lower_tri_self_transpose(cor_L);
    lpdf += normal_lpdf(cor[2,1] | point_mu_lower, point_scale_lower);
    return(lpdf);
  }

// pH and fi at a given time at column inlet
vector gra_state(real t,  vector hplcparam) {

vector[2] sol;
real tg = hplcparam[1];
real td = hplcparam[2];
real fio = hplcparam[5];
real fik = hplcparam[6];
real pHo = hplcparam[8];
real alpha1 = hplcparam[9];
real alpha2 = hplcparam[10];
real fi;

fi = fio+(fik-fio)/tg*(t-td);

if (t&lt;td)
fi = fio;
else if (t&gt;tg+td)
fi = fik;

sol[1]=fi;
sol[2]=pHo+alpha1*fi+alpha2*fi^2;

return sol;
}

real funlogki(vector logkwx, vector S1, vector pKaw, vector alpha, real S2, vector apH,
              int nDiss, vector chargesA, vector chargesB, vector fipH) {

real logki;
vector[3] logkix;
vector[2] pHmpKa;
real fi=fipH[1];
real pH=fipH[2];

logkix=logkwx-S1*fi/(1+S2*fi)+ chargesA*apH[1]*(pH-7) + chargesB*apH[2]*(pH-7);
pHmpKa=pH-(pKaw+alpha*fi);

if (nDiss==0) {
    logki = logkix[1]; 
}
else if (nDiss==1){
    logki=logkix[1] +
    log1p_exp(log(10)*(pHmpKa[1]+logkix[2]-logkix[1]))/log(10)-
    log1p_exp(log(10)*(pHmpKa[1]))/log(10);
}
else if (nDiss==2){
    logki = logkix[1] +
    log1p_exp(log(10)*(pHmpKa[1]+logkix[2]-logkix[1]) + 
    log1p_exp(log(10)*(pHmpKa[2]+logkix[3]-logkix[2])))/log(10)-
    log1p_exp(log(10)*(pHmpKa[1]) + 
    log1p_exp(log(10)*(pHmpKa[2])))/log(10);
}

return logki;
}

vector areaandslope(real time1, real time2, real invki1, real invki2) {

vector[2] cki_b;
real bo;
real cki;

if (invki2&gt;1.001*invki1) {
    bo = (log(invki2)-log(invki1))/(time2-time1);
    cki = (invki2-invki1)/bo;
}
else {
    bo  = 0.001/(time2-time1);
    cki = (time2-time1)*(invki2+invki1)/2;
}

cki_b[1] = cki;
cki_b[2] = bo;

return cki_b;
}

real chromgratrapz(int steps, 
           vector logkwx, vector logkmx, vector pKaw, vector alpha,
           real S2, vector apH, vector chargesA, vector chargesB,
           int nDiss, vector hplcparam) {

real tg = hplcparam[1];
real td = hplcparam[2];
real to = hplcparam[3];

vector[1] sol;
real time1;
real time2; 
vector[2] fipH1;
vector[2] fipH2;
real logki1;
real logki2; 
real invki1;
real invki2;
vector[2] cki_b;
real cumki1;
real cumki2;
real bo;
real tr;
real dt;

dt = tg/steps;

time1 = 0;
time2 = td;

fipH1 = gra_state(time1,  hplcparam);
// fipH2 = fipH1;

logki1 = funlogki(logkwx, logkmx, pKaw, alpha, S2, apH, nDiss, chargesA, chargesB, fipH1);
//logki2 = logki1;

invki1 = 1/to/10^logki1;
invki2 = invki1;

cumki1 = 0;
cumki2 = td*invki1; // cumulative area

bo     = 0.001/td;  // slope

for(x in 1:steps){ 
    if (cumki2&gt;=1)  continue;
    time1 = time2;
    time2 += dt;
//    fipH1 = fipH2;
    fipH2 = gra_state(time2,  hplcparam);
//    logki1 = logki2;
    logki2 = funlogki(logkwx, logkmx, pKaw, alpha, S2, apH, nDiss, chargesA, chargesB, fipH2);
    invki1 = invki2;
    invki2 = 1/to/10^logki2;
    cki_b = areaandslope(time1, time2, invki1, invki2);
    cumki1 = cumki2;
    cumki2 += cki_b[1]; // cumulative area
    bo      = cki_b[2]; //slope
}

if (cumki2&gt;=1) {
    tr = time1+log1p((1-cumki1)*bo/invki1)/bo;
}
else if (cumki2&lt;1) {
    tr = time2+(1-cumki2)/invki2;
}

return tr;
}

real partial_sum(int[] ind, int start, int end, vector trObs, 
int[] mod, int[] steps, int[] analyte,
vector[] hplcparam, vector[] chargesA, vector[] chargesB, int[] nDiss,
vector[] logkwx1, vector dlogkT1, vector[] S1mx1, vector[] S1ax1,
vector[] pKaw1, vector[] alpham1, vector[] alphaa1,
real S2m1, real S2a1,
vector apH1,
vector sigma1,
vector[] logkwx2, vector dlogkT2, vector[] S1mx2, vector[] S1ax2,
vector[] pKaw2, vector[] alpham2, vector[] alphaa2,
real S2m2, real S2a2,
vector apH2,
vector sigma2,
int[] column) {

real lp = 0;
real y_hat;

for(z in start:end){

if(column[z]==1){
if (mod[z]==1) {
y_hat = chromgratrapz(steps[z], 
       logkwx1[analyte[z],] + dlogkT1[analyte[z]]*hplcparam[z,11], 
       S1mx1[analyte[z],],  
       pKaw1[analyte[z],], 
       alpham1[analyte[z],],
       S2m1,
       apH1,
       chargesA[analyte[z],], 
       chargesB[analyte[z],], 
       nDiss[analyte[z]],
       hplcparam[z]);
 }

if (mod[z]==2) {
y_hat = chromgratrapz(steps[z], 
       logkwx1[analyte[z],]  + dlogkT1[analyte[z]]*hplcparam[z,11], 
       S1ax1[analyte[z],],  
       pKaw1[analyte[z],], 
       alphaa1[analyte[z],],
       S2a1,
       apH1,
       chargesA[analyte[z],],
       chargesB[analyte[z],], 
       nDiss[analyte[z]],
       hplcparam[z]);
}

  real trHat = hplcparam[z,3] + hplcparam[z,4] + y_hat; 

  lp = lp + student_t_lpdf(trObs[z] | 3, trHat, sigma1[analyte[z]]);

 }
 
if(column[z]==2){
if (mod[z]==1) {
y_hat = chromgratrapz(steps[z], 
       logkwx2[analyte[z],] + dlogkT2[analyte[z]]*hplcparam[z,11], 
       S1mx2[analyte[z],],  
       pKaw2[analyte[z],], 
       alpham2[analyte[z],],
       S2m2,
       apH2,
       chargesA[analyte[z],], 
       chargesB[analyte[z],], 
       nDiss[analyte[z]],
       hplcparam[z]);
 }

if (mod[z]==2) {
y_hat = chromgratrapz(steps[z], 
       logkwx2[analyte[z],]  + dlogkT2[analyte[z]]*hplcparam[z,11], 
       S1ax2[analyte[z],],  
       pKaw2[analyte[z],], 
       alphaa2[analyte[z],],
       S2a2,
       apH2,
       chargesA[analyte[z],],
       chargesB[analyte[z],], 
       nDiss[analyte[z]],
       hplcparam[z]);
}

  real trHat = hplcparam[z,3] + hplcparam[z,4] + y_hat; 

  lp = lp + student_t_lpdf(trObs[z] | 3, trHat, sigma2[analyte[z]]);

 }
 }
 return lp;
}
}

data{
int nAnalytes;             // number of analytes
int nObs;                  // number of observations
int npH;                   // npH;
int analyte[nObs];         // analyte indexes
int&lt;lower=1&gt; steps[nObs];   // steps for gradient retention time aproimation
vector[11] hplcparam[nObs]; // [tg, td, to, te, fio, fik, mod, pHo, alpha1, alpha2, (temp-25)/10]
int&lt;lower=0&gt; mod[nObs];     // MeOH==1, ACN==2 (repeats hplcparam(:,7))
int&lt;lower=0&gt; column[nObs];     // MeOH==1, ACN==2 (repeats hplcparam(:,7))

vector[nAnalytes] logPobs; 

int&lt;lower=0,upper=2&gt; maxR;
int&lt;lower=0,upper=2&gt; R[nAnalytes];
ordered[maxR] pKaslit[nAnalytes];
vector[maxR] pKasliterror[nAnalytes];
vector[maxR] groupsA[nAnalytes];
vector[maxR] groupsB[nAnalytes];
vector[maxR+1] chargesA[nAnalytes];
vector[maxR+1] chargesB[nAnalytes];

int&lt;lower=0&gt; K;                      //  number of predictors (functional groups)
matrix[nAnalytes, K] nrfungroups;   // predictor matrix (functional groups)   

vector[nObs] trobs; // observed retention factors 
}

transformed data {
int grainsize = 1;
int ind[nObs] = rep_array(1, nObs);
vector[3] point_mu_lower = [0.75,0.75,0.75]';       // mean priors for rho
vector[3] point_scale_lower = [0.125,0.125,0.125]'; // std priors for rho
}

parameters{
real logkwHat1;        // typical value of logkw [N]
real S1mHat1;          // typical value of S1m [N]
real S1aHat1;           // typical value of S1a [N]
real dlogkwHat1[2];     // typical value of dlogkw [A,B] 
real dSmHat1[2];        // typical value of dlogkm [A,B] 
real dSaHat1[2];        // typical value of dlogka [A,B] 
real&lt;lower = 0&gt; S2mHat1; // typical value of S2m 
real&lt;lower = 0&gt; S2aHat1; // typical value of S2a
vector[3] beta1;         // effects of logP 
real dlogkTHat1;         // typical dlogkT
vector[2] alphaAHat;  // changes of pKa with org. mod for acids [MeOH, ACN]
vector[2] alphaBHat;  // changes of pKa with org. mod for bases [MeOH, ACN]

vector&lt;lower = 0.01&gt;[3] omega1;   // between analyte variabilities (neutral forms)
corr_matrix[3] rho11;                           // correlation matrix    
vector&lt;lower = 0.01&gt;[3] kappa1;    // between analyte variabilities (diss. forms)
vector&lt;lower = 0.01&gt;[2] tau;     // between analyte variabilities for acids pKa
cholesky_factor_corr[2] L2;                         // cholesky 
real&lt;lower = 0.01, upper = 1&gt; omegadlogkT1;  // between analyte variability for temperature

// between buffer differences
vector[2] apH1; // pH effects

vector[K] pilogkw1;  // regression coefficient for logkw
vector[K] piS1m1;  // regression coefficient for S1m
vector[K] piS1a1;  // regression coefficient for S1a

vector&lt;lower = 0.01&gt;[3] sdpi1;     // between analyte variabilities for acids pKa

// residual variability
real&lt;lower = 0.01&gt; msigma1; // mean
real&lt;lower = 0.01&gt; ssigma1; // scale


real logkwHat2;        // typical value of logkw [N]
real S1mHat2;          // typical value of S1m [N]
real S1aHat2;           // typical value of S1a [N]
real dlogkwHat2[2];     // typical value of dlogkw [A,B] 
real dSmHat2[2];        // typical value of dlogkm [A,B] 
real dSaHat2[2];        // typical value of dlogka [A,B] 
real&lt;lower = 0&gt; S2mHat2; // typical value of S2m 
real&lt;lower = 0&gt; S2aHat2; // typical value of S2a
vector[3] beta2;         // effects of logP 
real dlogkTHat2;         // typical dlogkT

vector&lt;lower = 0.01&gt;[3] omega2;   // between analyte variabilities (neutral forms)
corr_matrix[3] rho12;                           // correlation matrix    
vector&lt;lower = 0.01&gt;[3] kappa2;    // between analyte variabilities (diss. forms)
real&lt;lower = 0.01, upper = 1&gt; omegadlogkT2;  // between analyte variability for temperature

// between buffer differences
vector[2] apH2; // pH effects

vector[K] pilogkw2;  // regression coefficient for logkw
vector[K] piS1m2;  // regression coefficient for S1m
vector[K] piS1a2;  // regression coefficient for S1a

vector&lt;lower = 0.01&gt;[3] sdpi2;     // between analyte variabilities for acids pKa

// residual variability
real&lt;lower = 0.01&gt; msigma2; // mean
real&lt;lower = 0.01&gt; ssigma2; // scale

// individual values of chromatographic parameters
vector[3] param1[nAnalytes]; 
vector[nAnalytes] dlogkT1;  
matrix[nAnalytes,maxR+1] dlogkwA1;
matrix[nAnalytes,maxR+1] dlogkwB1;
matrix[nAnalytes,maxR+1] dSmA1;
matrix[nAnalytes,maxR+1] dSmB1;
matrix[nAnalytes,maxR+1] dSaA1;
matrix[nAnalytes,maxR+1] dSaB1;

vector[maxR] pKaw1[nAnalytes];
matrix[maxR,nAnalytes] etaStd11;
matrix[maxR,nAnalytes] etaStd21;

vector[3] param2[nAnalytes]; 
vector[nAnalytes] dlogkT2;  
matrix[nAnalytes,maxR+1] dlogkwA2;
matrix[nAnalytes,maxR+1] dlogkwB2;
matrix[nAnalytes,maxR+1] dSmA2;
matrix[nAnalytes,maxR+1] dSmB2;
matrix[nAnalytes,maxR+1] dSaA2;
matrix[nAnalytes,maxR+1] dSaB2;

vector[maxR] pKaw2[nAnalytes];
matrix[maxR,nAnalytes] etaStd12;
matrix[maxR,nAnalytes] etaStd22;
// and residuals
vector&lt;lower = 0.01, upper = 4&gt;[nAnalytes] sigma1;
vector&lt;lower = 0.01, upper = 4&gt;[nAnalytes] sigma2;
}

transformed parameters{
vector[maxR+1] logkwx1[nAnalytes];
vector[maxR+1] S1mx1[nAnalytes];
vector[maxR+1] S1ax1[nAnalytes];
matrix[nAnalytes,maxR] alpha11;   //MeOH or ACN
matrix[nAnalytes,maxR] alpha21;   //MeOH or ACN

vector[maxR] alpham1[nAnalytes];
vector[maxR] alphaa1[nAnalytes];

vector[3] miu1[nAnalytes];  

vector[maxR+1] logkwx2[nAnalytes];
vector[maxR+1] S1mx2[nAnalytes];
vector[maxR+1] S1ax2[nAnalytes];
matrix[nAnalytes,maxR] alpha12;   //MeOH or ACN
matrix[nAnalytes,maxR] alpha22;   //MeOH or ACN

vector[maxR] alpham2[nAnalytes];
vector[maxR] alphaa2[nAnalytes];

vector[3] miu2[nAnalytes];  

cov_matrix[3] Omega1; // variance-covariance matrix

Omega1 = quad_form_diag(rho11, omega1); // diag_matrix(omega) * rho * diag_matrix(omega)

cov_matrix[3] Omega2; // variance-covariance matrix

Omega2 = quad_form_diag(rho12, omega2); // diag_matrix(omega) * rho * diag_matrix(omega)

// Matt's trick to use unit scale 
 alpha11 = diag_pre_multiply(tau, L2 * etaStd11)';
 alpha21 = diag_pre_multiply(tau, L2 * etaStd21)';
 alpha12 = diag_pre_multiply(tau, L2 * etaStd12)';
 alpha22 = diag_pre_multiply(tau, L2 * etaStd22)';

for(i in 1:nAnalytes){
    miu1[i,1]  = logkwHat1 + beta1[1] * (logPobs[i]-2.2) + nrfungroups[i] * pilogkw1;
    miu1[i,2]  = S1mHat1   + beta1[2] * (logPobs[i]-2.2) + nrfungroups[i] * piS1m1; 
    miu1[i,3]  = S1aHat1   + beta1[3] * (logPobs[i]-2.2) + nrfungroups[i] * piS1a1;

    miu2[i,1]  = logkwHat2 + beta2[1] * (logPobs[i]-2.2) + nrfungroups[i] * pilogkw2;
    miu2[i,2]  = S1mHat2   + beta2[2] * (logPobs[i]-2.2) + nrfungroups[i] * piS1m2; 
    miu2[i,3]  = S1aHat2   + beta2[3] * (logPobs[i]-2.2) + nrfungroups[i] * piS1a2;
}

for(i in 1:nAnalytes){
for(r in 1:maxR+1){
logkwx1[i,r] = param1[i, 1] +
            dlogkwA1[i,r]*chargesA[i,r] +
            dlogkwB1[i,r]*chargesB[i,r];
S1mx1[i,r] = (param1[i, 2] + 
            dSmA1[i,r]*chargesA[i,r] +
            dSmB1[i,r]*chargesB[i,r])*(1+(S2mHat1));
S1ax1[i,r] = (param1[i, 3] + 
            dSaA1[i,r]*chargesA[i,r] +
            dSaB1[i,r]*chargesB[i,r])*(1+(S2aHat1));

logkwx2[i,r] = param2[i, 1] +
            dlogkwA2[i,r]*chargesA[i,r] +
            dlogkwB2[i,r]*chargesB[i,r];
S1mx2[i,r] = (param2[i, 2] + 
            dSmA2[i,r]*chargesA[i,r] +
            dSmB2[i,r]*chargesB[i,r])*(1+(S2mHat2));
S1ax2[i,r] = (param2[i, 3] + 
            dSaA2[i,r]*chargesA[i,r] +
            dSaB2[i,r]*chargesB[i,r])*(1+(S2aHat2));

}}

for(i in 1:nAnalytes){
alpham1[i,1] = (alphaAHat[1]+alpha11[i,1]) * groupsA[i,1] + (alphaBHat[1]+alpha11[i,1]) * groupsB[i,1];
alpham1[i,2] = (alphaAHat[1]+alpha21[i,1]) * groupsA[i,2] + (alphaBHat[1]+alpha21[i,1]) * groupsB[i,2];

alphaa1[i,1] = (alphaAHat[2]+alpha11[i,2]) * groupsA[i,1] + (alphaBHat[2]+alpha11[i,2]) * groupsB[i,1];
alphaa1[i,2] = (alphaAHat[2]+alpha21[i,2]) * groupsA[i,2] + (alphaBHat[2]+alpha21[i,2]) * groupsB[i,2];

alpham2[i,1] = (alphaAHat[1]+alpha12[i,1]) * groupsA[i,1] + (alphaBHat[1]+alpha12[i,1]) * groupsB[i,1];
alpham2[i,2] = (alphaAHat[1]+alpha22[i,1]) * groupsA[i,2] + (alphaBHat[1]+alpha22[i,1]) * groupsB[i,2];

alphaa2[i,1] = (alphaAHat[2]+alpha12[i,2]) * groupsA[i,1] + (alphaBHat[2]+alpha12[i,2]) * groupsB[i,1];
alphaa2[i,2] = (alphaAHat[2]+alpha22[i,2]) * groupsA[i,2] + (alphaBHat[2]+alpha22[i,2]) * groupsB[i,2];
}

}
model{
logkwHat1  ~ normal(2.2, 2);
S1mHat1    ~ normal(4, 1);
S1aHat1    ~ normal(5, 1);
dlogkwHat1 ~ normal(-1,0.125);
dSmHat1    ~ normal(0,0.5);
dSaHat1    ~ normal(0,0.5);
S2mHat1    ~ lognormal(-1.6,0.125);
S2aHat1    ~ lognormal(0.69,0.125);
alphaAHat ~ normal(2,0.25);
alphaBHat ~ normal(-1,0.25);
beta1[{1}] ~ normal(1,0.125);
beta1[{2,3}] ~ normal(0.5,0.5);
omega1       ~ normal(0,2);
rho11         ~ lkj_corr_point_lower_tri(point_mu_lower, point_scale_lower);
kappa1       ~ normal(0,0.5);

apH1 ~ normal(0,0.1);

pilogkw1 ~ normal(0,sdpi1[1]);
piS1m1   ~ normal(0,sdpi1[2]);
piS1a1   ~ normal(0,sdpi1[3]);

sdpi1 ~ normal(0,0.1);

logkwHat2  ~ normal(2.2, 2);
S1mHat2    ~ normal(4, 1);
S1aHat2    ~ normal(5, 1);
dlogkwHat2 ~ normal(-1,0.125);
dSmHat2    ~ normal(0,0.5);
dSaHat2    ~ normal(0,0.5);
S2mHat2    ~ lognormal(-1.6,0.125);
S2aHat2    ~ lognormal(0.69,0.125);
beta2[{1}] ~ normal(1,0.125);
beta2[{2,3}] ~ normal(0.5,0.5);
omega2       ~ normal(0,2);
rho12         ~ lkj_corr_point_lower_tri(point_mu_lower, point_scale_lower);
kappa2       ~ normal(0,0.5);

apH2 ~ normal(0,0.1);

pilogkw2 ~ normal(0,sdpi2[1]);
piS1m2   ~ normal(0,sdpi2[2]);
piS1a2   ~ normal(0,sdpi2[3]);

sdpi2 ~ normal(0,0.1);


tau ~ normal(0,0.5);
L2 ~ lkj_corr_cholesky_point_lower_tri_two(0.75, 0.125);

dlogkTHat1   ~ normal(-0.087,0.022);
omegadlogkT1 ~ normal(0,0.022);

dlogkTHat2   ~ normal(-0.087,0.022);
omegadlogkT2 ~ normal(0,0.022);


sigma1  ~ lognormal(log(msigma1),ssigma1); 
sigma2  ~ lognormal(log(msigma2),ssigma2); 

msigma1 ~ normal(0,1);
ssigma1 ~ normal(0,1);

msigma2 ~ normal(0,1);
ssigma2 ~ normal(0,1);

for(i in  1:nAnalytes){
param1[i] ~ multi_normal(miu1[i],Omega1);
param2[i] ~ multi_normal(miu2[i],Omega2);
}

to_vector(dlogkwA1) ~ normal(dlogkwHat1[1],kappa1[1]);
to_vector(dlogkwB1) ~ normal(dlogkwHat1[2],kappa1[1]);
to_vector(dSmA1) ~ normal(dSmHat1[1],kappa1[2]);
to_vector(dSmB1) ~ normal(dSmHat1[2],kappa1[2]);
to_vector(dSaA1) ~ normal(dSaHat1[1],kappa1[3]);
to_vector(dSaB1) ~ normal(dSaHat1[2],kappa1[3]);

to_vector(etaStd11) ~ std_normal();
to_vector(etaStd21) ~ std_normal();

dlogkT1  ~ normal(dlogkTHat1,omegadlogkT1);

to_vector(dlogkwA2) ~ normal(dlogkwHat2[1],kappa2[1]);
to_vector(dlogkwB2) ~ normal(dlogkwHat2[2],kappa2[1]);
to_vector(dSmA2) ~ normal(dSmHat2[1],kappa2[2]);
to_vector(dSmB2) ~ normal(dSmHat2[2],kappa2[2]);
to_vector(dSaA2) ~ normal(dSaHat2[1],kappa2[3]);
to_vector(dSaB2) ~ normal(dSaHat2[2],kappa2[3]);

to_vector(etaStd12) ~ std_normal();
to_vector(etaStd22) ~ std_normal();

dlogkT2  ~ normal(dlogkTHat2,omegadlogkT2);

for (i in 1:nAnalytes){
 pKaw1[i] ~ normal(pKaslit[i],pKasliterror[i]);
 pKaw2[i] ~ normal(pKaslit[i],pKasliterror[i]);
 }

target += reduce_sum(partial_sum, ind, grainsize, trobs, 
        mod, steps, analyte, hplcparam, chargesA, chargesB, R,
        logkwx1, dlogkT1, S1mx1, S1ax1,
        pKaw1, alpham1, alphaa1,
        S2mHat1, S2aHat1,
        apH1, sigma1,
            logkwx2, dlogkT2, S1mx2, S1ax2,
        pKaw2, alpham2, alphaa2,
        S2mHat2, S2aHat2,
        apH2, sigma2,column);        
}</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: 4000 of 4000 (100.0%) transitions hit the maximum treedepth limit of 10.
See https://mc-stan.org/misc/warnings for details.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: 7 of 10 chains had an E-BFMI less than 0.2.
See https://mc-stan.org/misc/warnings for details.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: pojawiły się wartości NA na skutek przekształcenia

Warning: pojawiły się wartości NA na skutek przekształcenia</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>      variable  mean median   sd  mad    q5   q95 rhat ess_bulk ess_tail
 logkwHat1      3.13   3.13 0.09 0.09  2.99  3.26 1.01     1097     2263
 logkwHat2      3.70   3.69 0.10 0.10  3.53  3.87 1.04      278     1126
 S1mHat1        4.57   4.56 0.10 0.10  4.40  4.73 1.01      894     1928
 S1mHat2        5.27   5.28 0.12 0.12  5.08  5.46 1.02      724     1593
 S1aHat1        5.61   5.61 0.14 0.14  5.39  5.84 1.01      885     1644
 S1aHat2        6.01   6.01 0.15 0.15  5.76  6.25 1.01      827     1797
 dlogkwHat1[1] -0.71  -0.71 0.06 0.06 -0.82 -0.61 1.03      507      775
 dlogkwHat1[2] -0.91  -0.91 0.05 0.05 -0.99 -0.83 1.03      490     1251
 dlogkwHat2[1] -0.79  -0.79 0.07 0.07 -0.90 -0.69 1.05      161      632
 dlogkwHat2[2] -0.91  -0.91 0.06 0.06 -1.00 -0.82 1.06      125      756
 dSmHat1[1]     0.40   0.39 0.12 0.12  0.20  0.60 1.12       58      172
 dSmHat1[2]     0.08   0.08 0.07 0.07 -0.04  0.20 1.05      172      414
 dSmHat2[1]     0.12   0.12 0.13 0.13 -0.08  0.33 1.22       35      126
 dSmHat2[2]     0.64   0.64 0.10 0.10  0.48  0.81 1.22       35       70
 dSaHat1[1]     1.18   1.18 0.13 0.13  0.96  1.40 1.08       89      160
 dSaHat1[2]    -0.45  -0.45 0.08 0.08 -0.58 -0.33 1.04      207      393
 dSaHat2[1]     0.68   0.69 0.13 0.13  0.45  0.89 1.25       34      106
 dSaHat2[2]     0.24   0.24 0.10 0.10  0.08  0.42 1.21       33       80
 S2mHat1        0.31   0.31 0.03 0.03  0.26  0.35 1.05      150      388
 S2mHat2        0.49   0.49 0.04 0.04  0.43  0.56 1.12       56      169
 S2aHat1        0.76   0.75 0.04 0.03  0.70  0.82 1.07      131      324
 S2aHat2        1.25   1.25 0.06 0.06  1.15  1.35 1.12       60      140
 beta1[1]       0.73   0.73 0.03 0.03  0.67  0.78 1.01     1554     2512
 beta1[2]       0.35   0.35 0.04 0.04  0.28  0.42 1.01      715     1837
 beta1[3]       0.36   0.36 0.05 0.05  0.28  0.45 1.01      826     2074
 beta2[1]       0.77   0.77 0.04 0.04  0.71  0.83 1.01      946     2459
 beta2[2]       0.34   0.34 0.05 0.05  0.26  0.42 1.03      424     1586
 beta2[3]       0.41   0.41 0.06 0.05  0.32  0.50 1.02      496     1927
 alphaAHat[1]   2.03   2.03 0.14 0.13  1.81  2.26 1.01      909     1515
 alphaAHat[2]   2.18   2.19 0.19 0.18  1.88  2.49 1.00     1355     2186
 alphaBHat[1]  -1.01  -1.01 0.11 0.11 -1.19 -0.84 1.01      573     1319
 alphaBHat[2]  -1.13  -1.13 0.15 0.15 -1.39 -0.88 1.01      712     1331
 dlogkTHat1    -0.10  -0.10 0.00 0.00 -0.10 -0.09 1.00     5075     3134
 dlogkTHat2    -0.11  -0.11 0.00 0.00 -0.11 -0.10 1.00     3206     3176
 omegadlogkT1   0.03   0.03 0.00 0.00  0.03  0.03 1.00     3385     3230
 omegadlogkT2   0.04   0.04 0.00 0.00  0.03  0.04 1.00     2104     2549
 apH1[1]       -0.02  -0.02 0.00 0.00 -0.03 -0.02 1.00     2870     3286
 apH1[2]        0.08   0.08 0.00 0.00  0.08  0.08 1.01     1203     2234
 apH2[1]       -0.04  -0.04 0.00 0.00 -0.04 -0.03 1.01     1834     2881
 apH2[2]        0.06   0.06 0.00 0.00  0.06  0.06 1.00     3033     3446
 msigma1        0.30   0.29 0.02 0.02  0.26  0.33 1.00     6329     3095
 msigma2        0.50   0.50 0.03 0.03  0.45  0.56 1.00     5109     3169
 ssigma1        1.03   1.03 0.06 0.06  0.94  1.13 1.00     5628     3183
 ssigma2        0.90   0.90 0.05 0.05  0.82  0.98 1.00     5691     3258
 omega1[1]      0.62   0.62 0.04 0.04  0.56  0.68 1.01     1360     2530
 omega1[2]      0.69   0.69 0.05 0.05  0.61  0.77 1.01     1005     2011
 omega1[3]      0.95   0.94 0.07 0.07  0.84  1.07 1.01     1080     2247
 omega2[1]      0.67   0.66 0.05 0.05  0.59  0.75 1.02      797     1861
 omega2[2]      0.77   0.76 0.06 0.06  0.67  0.87 1.01      826     1648
 omega2[3]      0.97   0.96 0.07 0.07  0.86  1.10 1.00      952     2196
 rho11[1,1]     1.00   1.00 0.00 0.00  1.00  1.00   NA       NA       NA
 rho11[2,1]     0.80   0.81 0.04 0.04  0.74  0.86 1.01      946     2053
 rho11[3,1]     0.74   0.74 0.04 0.04  0.66  0.80 1.00     1217     2610
 rho11[1,2]     0.80   0.81 0.04 0.04  0.74  0.86 1.01      946     2053
 rho11[2,2]     1.00   1.00 0.00 0.00  1.00  1.00   NA       NA       NA
 rho11[3,2]     0.91   0.91 0.02 0.02  0.87  0.94 1.01     1103     2442
 rho11[1,3]     0.74   0.74 0.04 0.04  0.66  0.80 1.00     1217     2610
 rho11[2,3]     0.91   0.91 0.02 0.02  0.87  0.94 1.01     1103     2442
 rho11[3,3]     1.00   1.00 0.00 0.00  1.00  1.00   NA       NA       NA
 rho12[1,1]     1.00   1.00 0.00 0.00  1.00  1.00   NA       NA       NA
 rho12[2,1]     0.72   0.72 0.05 0.05  0.63  0.80 1.03      407     1380
 rho12[3,1]     0.73   0.73 0.04 0.04  0.65  0.79 1.03      557     1295
 rho12[1,2]     0.72   0.72 0.05 0.05  0.63  0.80 1.03      407     1380
 rho12[2,2]     1.00   1.00 0.00 0.00  1.00  1.00   NA       NA       NA
 rho12[3,2]     0.90   0.90 0.02 0.02  0.86  0.93 1.01      972     2069
 rho12[1,3]     0.73   0.73 0.04 0.04  0.65  0.79 1.03      557     1295
 rho12[2,3]     0.90   0.90 0.02 0.02  0.86  0.93 1.01      972     2069
 rho12[3,3]     1.00   1.00 0.00 0.00  1.00  1.00   NA       NA       NA
 L2[1,1]        1.00   1.00 0.00 0.00  1.00  1.00   NA       NA       NA
 L2[2,1]        0.88   0.89 0.02 0.02  0.84  0.92 1.02      373     1009
 L2[1,2]        0.00   0.00 0.00 0.00  0.00  0.00   NA       NA       NA
 L2[2,2]        0.47   0.46 0.05 0.05  0.40  0.54 1.02      373     1009
 kappa1[1]      0.52   0.51 0.03 0.03  0.47  0.57 1.02      387      839
 kappa1[2]      0.44   0.43 0.05 0.05  0.36  0.52 1.12       59      286
 kappa1[3]      0.52   0.52 0.05 0.04  0.45  0.60 1.06      180      389
 kappa2[1]      0.56   0.56 0.04 0.04  0.50  0.64 1.23       32      108
 kappa2[2]      0.46   0.45 0.06 0.05  0.36  0.55 1.18       45      176
 kappa2[3]      0.44   0.44 0.05 0.05  0.36  0.53 1.12       66      189
 tau[1]         1.75   1.74 0.13 0.13  1.55  1.97 1.05      166      555
 tau[2]         2.78   2.77 0.18 0.18  2.50  3.09 1.03      368      745</code></pre>
</div>
</div>



</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./Model_2_utility_pH.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Utility function</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
  </div>
</nav>
</div> <!-- /content -->



</body></html>